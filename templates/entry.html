<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labour Entry</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/entry.css') }}">   
    <style>
        /* Additional styles for edit functionality */
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-edit, .btn-delete {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-edit {
            background-color: #007bff;
            color: white;
        }
        
        .btn-edit:hover {
            background-color: #0056b3;
        }
        
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #c82333;
        }
        
        .edit-mode {
            background-color: #f8f9fa;
            border: 2px solid #007bff;
        }
        
        .form-title {
            color: #333;
            margin-bottom: 10px;
        }
        
        .edit-title {
            color: #007bff;
        }
        
        .btn-cancel {
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .btn-cancel:hover {
            background-color: #545b62;
        }
        
        .no-entries {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .entries-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .entries-table th,
        .entries-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .entries-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .entries-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .amount-cell {
            text-align: right;
            font-weight: bold;
        }
    </style>
    <script>
        const activityRates = {
            "Corner Bead": { 
                unit: "Nos", 
                unit_rates: [2.75, 5.0], 
                hr_rates: [3.69, 10.0] 
            },
            "Plaster": { 
                unit: "sq.m", 
                unit_rates: [2.75, 4.0], 
                hr_rates: [3.69, 10.0] 
            },
            "Spot Level": { 
                unit: "sq.m", 
                unit_rates: [0.25, 0.5], 
                hr_rates: [3.69, 10.0] 
            },
            "Conduit Filling": { 
                unit: "hr", 
                unit_rates: [], 
                hr_rates: [3.08, 7.0] 
            },
            "Keycoat": { 
                unit: "sq.m", 
                unit_rates: [0.7], 
                hr_rates: [3.08, 7.0] 
            },
            "Mesh Fixing": { 
                unit: "Rn.M", 
                unit_rates: [0.28], 
                hr_rates: [3.08, 7.0] 
            },
            "Mesh Filling": { 
                unit: "hr", 
                unit_rates: [], 
                hr_rates: [3.08, 7.0] 
            },
            "Fiber Mesh Fixing": { 
                unit: "Rn.M", 
                unit_rates: [0.56], 
                hr_rates: [3.08, 7.0] 
            }
        };

        let isEditMode = false;
        let editingEntryId = null;

        function updateRateUnit() {
            const activity = document.getElementById('activity').value;
            const unitInput = document.getElementById('unit');
            const rateTypeSelect = document.getElementById('rate_type');
            const rateSelect = document.getElementById('rate');
            
            if (activityRates[activity]) {
                const rates = activityRates[activity];
                unitInput.value = rates.unit;

                // Reset Rate Type and Rate options
                rateTypeSelect.value = '';
                rateSelect.innerHTML = '<option value="">--Select Rate--</option>';
                
                // Clear amount and other fields
                document.getElementById('amount').value = '';
                document.getElementById('qty').value = '';
                document.getElementById('total_hours').value = '';
            }
        }

        function updateRateOptions() {
            const activity = document.getElementById('activity').value;
            const rateType = document.getElementById('rate_type').value;
            const rateSelect = document.getElementById('rate');

            rateSelect.innerHTML = '<option value="">--Select Rate--</option>';

            if (activityRates[activity]) {
                let ratesList = [];
                if (rateType === 'Unit') {
                    ratesList = activityRates[activity].unit_rates;
                } else if (rateType === 'Hour') {
                    ratesList = activityRates[activity].hr_rates;
                }

                ratesList.forEach(rate => {
                    const option = document.createElement('option');
                    option.value = rate;
                    option.textContent = rate;
                    rateSelect.appendChild(option);
                });
            }
            
            // Clear amount when rate type changes
            document.getElementById('amount').value = '';
        }

        function calculateAmount() {
            const rate = parseFloat(document.getElementById('rate').value) || 0;
            const qty = parseFloat(document.getElementById('qty').value) || 0;
            const totalHours = parseFloat(document.getElementById('total_hours').value) || 0;
            const rateType = document.getElementById('rate_type').value;

            let amount = 0;
            
            if (rate > 0) {
                if (rateType === 'Hour') {
                    // For hourly rates: Rate × Total Hours
                    amount = rate * totalHours;
                } else if (rateType === 'Unit') {
                    // For unit rates: Rate × Quantity
                    amount = rate * qty;
                }
            }

            document.getElementById('amount').value = amount.toFixed(2);
        }

        function toggleFields() {
            const rateType = document.getElementById('rate_type').value;
            const qtyField = document.getElementById('qty');
            const hoursField = document.getElementById('total_hours');
            
            if (rateType === 'Hour') {
                // Enable hours, disable quantity
                hoursField.required = true;
                qtyField.required = false;
                qtyField.value = '';
            } else if (rateType === 'Unit') {
                // Enable quantity, disable hours
                qtyField.required = true;
                hoursField.required = false;
                hoursField.value = '';
            } else {
                // Both optional if no rate type selected
                qtyField.required = false;
                hoursField.required = false;
            }
            
            calculateAmount();
        }

        function editEntry(entryId) {
            if (isEditMode) {
                alert('Please finish editing the current entry first.');
                return;
            }

            fetch(`/api/entry/${entryId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch entry data');
                    }
                    return response.json();
                })
                .then(data => {
                    // Switch to edit mode
                    isEditMode = true;
                    editingEntryId = entryId;
                    
                    // Update form title
                    document.querySelector('.form-title').textContent = 'Edit Labour Entry';
                    document.querySelector('.form-title').classList.add('edit-title');
                    
                    // Add visual indication
                    document.querySelector('.form-container').classList.add('edit-mode');
                    
                    // Populate form fields
                    document.getElementById('labour_id').value = data.labour_id;
                    document.getElementById('activity').value = data.activity;
                    document.getElementById('status').value = data.status;
                    document.getElementById('unit').value = data.unit;
                    document.getElementById('rate_type').value = data.rate_type;
                    
                    // Update rate options based on activity and rate type
                    updateRateUnit();
                    updateRateOptions();
                    
                    // Set rate value after options are populated
                    setTimeout(() => {
                        document.getElementById('rate').value = data.rate;
                        document.getElementById('total_hours').value = data.total_hours || '';
                        document.getElementById('qty').value = data.qty || '';
                        document.getElementById('amount').value = data.amount;
                    }, 100);
                    
                    // Toggle fields based on rate type
                    toggleFields();
                    
                    // Update form action and submit button
                    const form = document.querySelector('form');
                    const submitBtn = document.querySelector('.submit-btn');
                    
                    // Add hidden input for action and entry_id
                    let actionInput = document.getElementById('action-input');
                    if (!actionInput) {
                        actionInput = document.createElement('input');
                        actionInput.type = 'hidden';
                        actionInput.name = 'action';
                        actionInput.id = 'action-input';
                        form.appendChild(actionInput);
                    }
                    actionInput.value = 'edit';
                    
                    let entryIdInput = document.getElementById('entry-id-input');
                    if (!entryIdInput) {
                        entryIdInput = document.createElement('input');
                        entryIdInput.type = 'hidden';
                        entryIdInput.name = 'entry_id';
                        entryIdInput.id = 'entry-id-input';
                        form.appendChild(entryIdInput);
                    }
                    entryIdInput.value = entryId;
                    
                    // Change submit button text and add cancel button
                    submitBtn.value = 'Update Entry';
                    
                    if (!document.getElementById('cancel-btn')) {
                        const cancelBtn = document.createElement('button');
                        cancelBtn.type = 'button';
                        cancelBtn.id = 'cancel-btn';
                        cancelBtn.className = 'btn-cancel';
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.onclick = cancelEdit;
                        submitBtn.parentNode.insertBefore(cancelBtn, submitBtn);
                    }
                    
                    // Scroll to form
                    document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    console.error('Error fetching entry data:', error);
                    alert('Error loading entry data. Please try again.');
                });
        }

        function cancelEdit() {
            // Reset edit mode
            isEditMode = false;
            editingEntryId = null;
            
            // Reset form title
            document.querySelector('.form-title').textContent = 'Basic Information';
            document.querySelector('.form-title').classList.remove('edit-title');
            
            // Remove visual indication
            document.querySelector('.form-container').classList.remove('edit-mode');
            
            // Reset form
            document.querySelector('form').reset();
            
            // Remove hidden inputs
            const actionInput = document.getElementById('action-input');
            const entryIdInput = document.getElementById('entry-id-input');
            if (actionInput) actionInput.remove();
            if (entryIdInput) entryIdInput.remove();
            
            // Reset submit button
            document.querySelector('.submit-btn').value = 'Submit Entry';
            
            // Remove cancel button
            const cancelBtn = document.getElementById('cancel-btn');
            if (cancelBtn) cancelBtn.remove();
        }

        function deleteEntry(entryId) {
            if (!confirm('Are you sure you want to delete this entry?')) {
                return;
            }

            fetch(`/entry/delete/${entryId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload(); // Refresh the page to update the entries list
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error deleting entry:', error);
                alert('Error deleting entry. Please try again.');
            });
        }

        // Prevent form submission if in edit mode without proper setup
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                if (isEditMode && !document.getElementById('action-input')) {
                    e.preventDefault();
                    alert('Error in edit mode setup. Please cancel and try again.');
                }
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Labour Entry System</h2>
            <p>Welcome, {{ employee.username }} | Site: {{ employee.site.name }}</p>
        </div>

        <div class="form-container">
            <form method="POST">
                <div class="form-grid">
                    <!-- Left Section: Basic Information -->
                    <div class="form-section">
                        <h3 class="section-title form-title">Basic Information</h3>
                        
                        <div class="form-group">
                            <label for="labour_id">Labour ID</label>
                            <input list="labourList" name="labour_id" id="labour_id" required placeholder="Select or type Labour ID">
                            <datalist id="labourList">
                                {% for labour in labours %}
                                    <option value="{{ labour.labour_id }}">{{ labour.labour_id }} - {{ labour.name }}</option>
                                {% endfor %}
                            </datalist>
                        </div>

                        <div class="form-group">
                            <label for="activity">Activity Type</label>
                            <select name="activity" id="activity" onchange="updateRateUnit()" required>
                                <option value="">--Select Activity--</option>
                                {% for act in activities %}
                                <option value="{{ act }}">{{ act }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="status">Attendance Status</label>
                            <select name="status" id="status" required>
                                <option value="Present">Present</option>
                                <option value="Absent">Absent</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="unit">Unit of Measurement</label>
                            <input type="text" name="unit" id="unit" readonly placeholder="Auto-filled">
                        </div>
                    </div>

                    <!-- Right Section: Rate & Calculation -->
                    <div class="form-section">
                        <h3 class="section-title">Rate & Calculation</h3>
                        
                        <div class="form-group">
                            <label for="rate_type">Rate Type</label>
                            <select name="rate_type" id="rate_type" onchange="updateRateOptions(); toggleFields()" required>
                                <option value="">--Select Rate Type--</option>
                                <option value="Unit">By Unit</option>
                                <option value="Hour">By Hour</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="rate">Rate (₹)</label>
                            <select name="rate" id="rate" onchange="calculateAmount()" required>
                                <option value="">--Select Rate--</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="total_hours">Total Hours</label>
                            <input type="number" step="0.1" name="total_hours" id="total_hours" oninput="calculateAmount()" placeholder="Required for hourly rates">
                        </div>

                        <div class="form-group">
                            <label for="qty">Quantity</label>
                            <input type="number" step="0.1" name="qty" id="qty" oninput="calculateAmount()" placeholder="Required for unit rates">
                        </div>

                        <div class="form-group">
                            <label for="amount">Final Amount (₹)</label>
                            <input type="number" step="0.01" name="amount" id="amount" class="amount-display" readonly placeholder="0.00">
                        </div>
                    </div>
                </div>

                <input type="submit" value="Submit Entry" class="submit-btn">
            </form>

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="messages">
                    <ul>
                    {% for category, message in messages %}
                        <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                    </ul>
                </div>
            {% endif %}
            {% endwith %}
        </div>

        <!-- Labour Entries List -->
        <div class="entries-container">
            <h3>Today's Labour Entries</h3>
            {% if labour_entries %}
                <table class="entries-table">
                    <thead>
                        <tr>
                            <th>Labour ID</th>
                            <th>Labour Name</th>
                            <th>Activity</th>
                            <th>Status</th>
                            <th>Rate Type</th>
                            <th>Rate</th>
                            <th>Hours</th>
                            <th>Quantity</th>
                            <th>Amount (₹)</th>
                            <th>Entry Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for entry in labour_entries %}
                    <tr>
                        <td>{{ entry.labour.labour_id }}</td>
                        <td>{{ entry.labour.name }}</td>
                        <td>{{ entry.activity }}</td>
                        <td>{{ entry.status }}</td>
                        <td>{{ entry.rate_type }}</td>
                        <td>₹{{ entry.rate }}</td>
                        <td>{{ entry.total_hours if entry.total_hours else '-' }}</td>
                        <td>{{ entry.qty if entry.qty else '-' }}</td>
                        <td class="amount-cell">₹{{ "%.2f"|format(entry.amount) }}</td>
                        <td>{{ entry.timestamp.strftime('%H:%M:%S') }}</td>
                        <td>
                            <div class="action-buttons">
                                <button type="button" class="btn-edit" onclick="editEntry({{ entry.id }})">Edit</button>
                                <button type="button" class="btn-delete" onclick="deleteEntry({{ entry.id }})">Delete</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="no-entries">
                    <p>No labour entries found for today.</p>
                </div>
            {% endif %}
        </div>
    </div>
</body>
</html>